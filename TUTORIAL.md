## 使用流程

1. 首先由交易中心创建一个 **OrderMarket** 智能合约(合约代码见 OrderMarket.sol).
2. 各个卖家调用交易中心创建的 AuctionOrder 智能合约，使用该合约，为自己想要发布的**订单**创建一个新的的智能合约(合约代码
   见 AuctionOrder.sol).
3. 买家使用订单合约进行对该订单的出价，最后获得订单拍卖的结果.

### 1. 交易中心使用流程

#### 1.1 交易中心创建 OrderMarket 智能合约

交易中心使用首先需要创建一个 **OrderMarket** 智能合约实例，以下简称为合约 O (合约代码见 OrderMarket.sol). 合约 O 代表了
一个订单交易市场. 交易中心可以创建多个不同的 **OrderMarket** 实例，每个实例分别代表每一个不同的订单交易市场.

创建合约时交易中心需要输入一个 **maxOrderCount**, 该变量代表每个卖家至多有多少个正在进行中(即订单状态为 OPEN)的订单合约.

#### 1.2 交易中心使用 OrderMarket 智能合约

交易中心可以使用 **OrderMarket** 合约中的 **setMaxOrderCount** 函数来修改 **maxOrderCount** 的值. 这个函数被设置为只有交
易中心可以调用. 减小 **MaxOrderCount** 的值不会影响当前已经创建的合约：例如，交易中心一开始将 **maxOrderCount** 设置为
3，然后 Bob 创建了 3 个订单，此时，交易中心将 **MaxOrderCount** 修改为 2，此时 Bob 已经创建的 3 个订单不会受影响，但 Bob
不能创建新的订单，直到 Bob 正在进行中的订单个数小于 2，Bob 才能创建新的订单.

**OrderMarket**智能合约中存储了 2 个公开的映射：

1. 从地址类型映到 uint 类型的映射**\_orderCount**, 记录了每个卖家地址下正在进行拍卖的订单数量.
2. 从地址类型映到地址类型的映射**\_orderOwner**, 记录了每个订单合约对应的卖家.

### 2. 交易双方使用流程

#### 2.1 卖家创建订单

卖家使用交易中心创建的合约 O 中的**createNewOrder**函数为自己的订单创建一个新的智能合约，以下简称为**订单合约**. 卖家创
建订单合约需要输入：卖家的 TFHE 公钥（为了在拍卖结束后得到成交的买家的报价信息）、订单描述信息，煤种类、可接受的最低价格
、交易总量、单一买家最小购买数量、拍卖持续时间.

##### 订单的状态

订单有 4 种状态：

1. OPEN: 表明订单在正常出价环节之中，没有被取消，没有达到截至时间.
2. CLOSED: 订单没有被卖家取消，但超过了截至时间，此时任何人不能再进行报价.
3. CANCELLED: 订单还没到截止时间就被卖家提前取消
4. COMPLETED: 订单经过了 CLOSED 状态，已经计算出了拍卖结果，现在卖方可以获得交易结果，买方可以得知自己是否成交.

#### 2.2 买家进行报价

卖家成功创建订单合约这一事件会在区块链上广播，有意的买家可以通过订单合约中的**bid**函数进行报价，买家需要输入：出价的明
文、购买数量的密文、买家的 TFHE 公钥（为了在拍卖结束后得知自己是否成交）. 在下面的情况下买家的报价会被拒绝：

1. 买家输入的出价小于卖家设置的最低价格
2. 买家输入的购买数量低于卖家设置的最小购买数量
3. 该买家对这一订单，**已经成功报价一次.**
4. 该订单已经被卖家撤回, 或超过了截止时间，拍卖已经结束.

#### 2.3 拍卖正常结束

##### 2.3.1 卖家使用 complete

当拍卖时间超过了卖家设置的持续时间，且该订单没有被卖家取消，那么拍卖正常结束, 此时该订单的状态会被设置为 CLOSED. 此时需
要卖家调用订单合约中的**complete** 函数. 该函数**只能由卖家**使用，且必须在拍卖事件超过截止时间才能使用. 该函数会计算出
拍卖结果的密文，并将订单的状态修改为 COMPLETED.

##### 2.3.2 卖家使用 getTopBids

此步骤必须发生在 2.3.1 之后. 卖家使用订单合约中的**getTopBids**函数得到成交的几个买家的地址、出价、购买数量. 该函数**只
能由卖家使用.**

##### 2.3.3 买家使用 getQuantity

此步骤必须发生在 2.3.1 之后（但不必在 2.3.2 之后）. 买家使用订单合约中的**getQuantity**函数来得到自己成交的数量(在当前设
定下，成交数量要么等于 0 要么等于买家 bid 时设置的购买数量). 只有对该订单有成功报价的买家才可以使用此函数.

#### 2.4 拍卖被卖家取消（非正常结束）

卖家可以使用订单合约中的**cancelOrder**函数来取消这个订单，该功能执行后订单的状态会被变更为 CANCELLED. 使用取消功能必须
满足以下的条件：

1. 使用者必须是该订单合约的卖方
2. 该订单必须处在 OPEN 状态之中

### 3. 订单合约的其他的功能

下面是一些任何人都可以使用的辅助功能：

1. 订单合约的 owner 变量，代表该订单对应的卖家的地址.
2. 订单合约的 marketAddress 变量，代表该订单所属于的合约 O 的地址.
3. 订单合约的 orderDetail 变量，该变量代表订单的明细信息.
4. 订单合约的 state 变量，查看此订单的状态. **注意**： 由于区块链的原因，若订单超过了截至时间，订单合约的状态不会自动从
   OPEN 变为 CLOSED(对比下面的 refreshState 功能), 此时 state 变量的值可能还是 OPEN. 但此时任何的报价行为都不会成功，且
   该报价行为会将 state 变量的值修改为 CLOSED.
5. 可以使用订单合约的 refreshState 函数，来更新订单的状态.
6. 订单合约的 currentBidderIndex 变量，该变量代表当前有多少买家报价.
7. 订单合约的 winnersNum 变量, 该变量代表该订单有多少买家成交.
8. 订单合约的 biddingMap 映射，来查询任何一个买家的报价密文.
9. 订单合约的 bidderList 变量，该变量是成功出价的买家的列表.
